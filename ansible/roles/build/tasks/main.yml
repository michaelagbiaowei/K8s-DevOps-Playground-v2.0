---
# tasks for build

- name: Create a tar.bz2 archive for the build files on the local machine
  archive:
    path: 
      - "{{local_path}}/docker/.dockerignore"
      - "{{local_path}}/docker/app.js"
      - "{{local_path}}/docker/Dockerfile"
    dest: "{{local_path}}/docker/docker.tar.bz2"
    format: bz2
  delegate_to: localhost

- name: unarchived files on remote machine
  unarchive:
    src: "{{local_path}}/docker/docker.tar.bz2"
    dest: "{{remote_path}}"
    
    
- name: Run npm install command
  command: npm install express
  args:
    chdir: "{{remote_path}}"

- name: Log in to Docker Hub
  docker_login:
    username: "{{ docker_username }}"
    password: "{{ docker_password }}"

- name: "Build - Docker image from Dockerfile"
  docker_image:
    build:
      path: "{{remote_path}}"
    name: "{{docker_username}}/{{docker_image_name}}"
    tag: "{{item}}"
    push: yes
    source: build
  with_items:
    - latest

- name: Remove image
  docker_image:
    state: absent
    name: "{{docker_username}}/{{docker_image_name}}"
    tag: latest
