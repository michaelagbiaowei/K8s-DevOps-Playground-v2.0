---
# tasks for build

- name: Create a tar.gz archive for the build files on the local machine
  archive:
    path: 
      - "{{local_path}}/docker/.dockerignore"
      - "{{local_path}}/docker/app.js"
      - "{{local_path}}/docker/Dockerfile"
    dest: "{{local_path}}/docker/docker.tar.bz2"
    format: bz2
  delegate_to: localhost

- name: unarchived files on remote machine
  unarchive:
    src: "{{local_path}}/docker/docker.tar.bz2"
    dest: "{{remote_path}}"
    
    
- name: Run npm install command
  command: npm install express
  args:
    chdir: "{{remote_path}}"

- name: Log in to Docker Hub
  docker_login:
    username: "{{ docker_username }}"
    password: "{{ docker_password }}"
    email: "{{ docker_email }}"

- name: "Build - Docker image from Dockerfile"
  docker_image:
    build:
      path: "{{remote_path}}"
    name: "{{docker_username}}/{{docker_image_name}}"
    tag: "{{item}}"
    push: yes
    source: build
  with_items:
    - latest

# - name: Build and Push Docker Image to Docker Hub
#   docker_image_build:
#     path: "{{remote_path}}/Dockerfile"
#     tag: "{{docker_hub_repo}}/{{docker_image_name }}:{{ docker_image_tag }}"
#     push: yes
