---
# tasks for build

- name: Create a tar.gz archive for the build files on the local machine
  archive:
    path: "{{local_path}}/docker"
    dest: "{{local_path}}/docker.tar.gz"
    format: gz
    force_archive:
  delegate_to: localhost

- name: Ensure the destination directory exists on the remote machine
  file:
    path: "{{remote_path}}"
    state: directory

- name: unarchived files on remote machine
  unarchive:
    src: "{{local_path}}/docker.tar.gz"
    dest: "{{remote_path}}"
    remote_src: yes

- name: Run npm install command
  command: npm install express
  args:
    chdir: {{remote_path}}

- name: Log in to Docker Hub
  docker_login:
    username: "{{ docker_username }}"
    password: "{{ docker_password }}"
    email: "{{ docker_email }}"

- name: "Build - Docker image from Dockerfile"
  docker_image:
    build:
      path: "{{remote_path}}/Dockerfile"
    name: "{{docker_image_name}}"
    tag: "{{item}}"
    push: yes
    source: build
  with_items:
    - "latest"

# - name: Build and Push Docker Image to Docker Hub
#   docker_image_build:
#     path: "{{remote_path}}/Dockerfile"
#     tag: "{{docker_hub_repo}}/{{docker_image_name }}:{{ docker_image_tag }}"
#     push: yes